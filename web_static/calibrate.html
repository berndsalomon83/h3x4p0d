<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hexapod Calibration</title>
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
  <style>
    :root {
      --bg: #0a0e14;
      --panel: #0f1419;
      --border: #1f2937;
      --text: #e6efff;
      --muted: #9ca3af;
      --accent: #3b82f6;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    h1 {
      font-size: 28px;
      margin-bottom: 8px;
      color: var(--accent);
    }
    .status-bar {
      display: flex;
      justify-content: center;
      gap: 20px;
      font-size: 14px;
      color: var(--muted);
    }
    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--danger);
    }
    .status-dot.connected { background: var(--success); }
    .status-dot.hardware { background: var(--warning); }

    .overview-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 20px 0;
    }
    .overview-card {
      flex: 1;
      min-width: 240px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .overview-label {
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-size: 11px;
      color: var(--muted);
    }
    .overview-value {
      font-size: 15px;
      font-weight: 700;
      color: var(--text);
      word-break: break-all;
    }
    .overview-meta {
      font-size: 13px;
      color: var(--muted);
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media (max-width: 900px) {
      .main-grid { grid-template-columns: 1fr; }
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }
    .panel-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Hexapod Diagram */
    .hexapod-diagram {
      background: #1a1f2e;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .hexapod-svg {
      width: 100%;
      height: 200px;
    }
    .leg-group {
      cursor: pointer;
      transition: all 0.2s;
    }
    .leg-group:hover .leg-circle {
      filter: brightness(1.3);
    }
    .leg-group.selected .leg-circle {
      stroke: var(--accent);
      stroke-width: 3;
      filter: drop-shadow(0 0 8px var(--accent));
    }
    .leg-group.configured .leg-circle {
      fill: var(--success);
    }
    .leg-circle {
      fill: #4a5568;
      stroke: #6b7280;
      stroke-width: 2;
      transition: all 0.2s;
    }
    .leg-label {
      fill: #fff;
      font-size: 11px;
      font-weight: 600;
      text-anchor: middle;
      pointer-events: none;
    }

    /* Joint Controls */
    .joint-controls {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .joint-row {
      background: #1a1f2e;
      border-radius: 8px;
      padding: 16px;
    }
    .joint-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .joint-name {
      font-weight: 600;
      font-size: 14px;
    }
    .joint-channel {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .channel-input {
      width: 60px;
      padding: 6px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 14px;
      text-align: center;
    }
    .channel-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .angle-control {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .angle-slider {
      flex: 1;
      height: 8px;
      -webkit-appearance: none;
      background: linear-gradient(to right, var(--danger), var(--warning), var(--success));
      border-radius: 4px;
      outline: none;
    }
    .angle-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .angle-value {
      min-width: 50px;
      text-align: right;
      font-weight: 600;
      font-size: 14px;
      color: var(--accent);
    }
    .test-btn {
      padding: 6px 12px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .test-btn:hover {
      background: #2563eb;
    }
    .test-btn.testing {
      background: var(--warning);
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Action Buttons */
    .actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 16px;
    }
    .action-btn {
      padding: 12px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-btn.primary {
      background: var(--accent);
      color: #fff;
    }
    .action-btn.primary:hover {
      background: #2563eb;
    }
    .action-btn.success {
      background: var(--success);
      color: #fff;
    }
    .action-btn.success:hover {
      background: #16a34a;
    }
    .action-btn.warning {
      background: var(--warning);
      color: #000;
    }
    .action-btn.warning:hover {
      background: #d97706;
    }
    .action-btn.danger {
      background: var(--danger);
      color: #fff;
    }
    .action-btn.danger:hover {
      background: #dc2626;
    }
    .action-btn.secondary {
      background: #374151;
      color: #fff;
    }
    .action-btn.secondary:hover {
      background: #4b5563;
    }

    /* Channel Map */
    .channel-map {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin-top: 12px;
    }
    .channel-slot {
      aspect-ratio: 1;
      background: #1a1f2e;
      border: 1px solid var(--border);
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .channel-slot:hover {
      border-color: var(--accent);
    }
    .channel-slot.occupied {
      background: rgba(59, 130, 246, 0.2);
      border-color: var(--accent);
    }
    .channel-slot .ch-num {
      font-weight: 700;
      font-size: 14px;
      color: var(--accent);
    }
    .channel-slot .ch-label {
      font-size: 9px;
      color: var(--muted);
      margin-top: 2px;
    }

    /* Log */
    .log-area {
      height: 150px;
      background: #0a0e14;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
      font-family: 'Consolas', monospace;
      font-size: 11px;
      overflow-y: auto;
      color: #22c55e;
    }
    .log-entry {
      margin-bottom: 4px;
    }
    .log-entry.error { color: var(--danger); }
    .log-entry.warn { color: var(--warning); }
    .log-entry.info { color: var(--muted); }

    /* Quick Test Panel */
    .quick-test {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .quick-btn {
      padding: 8px;
      background: #374151;
      border: none;
      border-radius: 4px;
      color: #fff;
      font-size: 11px;
      cursor: pointer;
    }
    .quick-btn:hover {
      background: #4b5563;
    }

    /* Footer */
    footer {
      margin-top: 30px;
      text-align: center;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
    }
    footer a {
      color: var(--accent);
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Hexapod Servo Calibration</h1>
      <div class="status-bar">
        <div class="status-item">
          <span class="status-dot" id="connectionDot"></span>
          <span id="connectionText">Connecting...</span>
        </div>
        <div class="status-item">
          <span class="status-dot" id="hardwareDot"></span>
          <span id="hardwareText">Hardware: Unknown</span>
        </div>
      </div>
    </header>

    <div class="overview-grid">
      <div class="overview-card">
        <div class="overview-label">Server endpoint</div>
        <div class="overview-value" id="serverEndpoint">localhost:8001</div>
        <div class="overview-meta">REST + WebSocket connection</div>
      </div>
      <div class="overview-card">
        <div class="overview-label">Calibration file</div>
        <div class="overview-value" id="calibrationPath">Not detected</div>
        <div class="overview-meta" id="calibrationMeta">Waiting for status...</div>
      </div>
      <div class="overview-card">
        <div class="overview-label">Mapping coverage</div>
        <div class="overview-value" id="mappingSummary">No joints mapped</div>
        <div class="overview-meta" id="mappingMeta">Tracks configured channels per leg</div>
      </div>
    </div>

    <div class="main-grid">
      <!-- Left Panel: Hexapod & Leg Selection -->
      <div class="panel">
        <div class="panel-title">
          <span>Select Leg</span>
        </div>

        <div class="hexapod-diagram">
          <svg class="hexapod-svg" viewBox="0 0 300 200" id="hexapodDiagram">
            <!-- Body -->
            <ellipse cx="150" cy="100" rx="50" ry="35" fill="#2d3748" stroke="#4a5568" stroke-width="2"/>
            <text x="150" y="105" text-anchor="middle" fill="#6b7280" font-size="12" font-weight="bold">BODY</text>
            <!-- Direction arrow -->
            <polygon points="150,50 143,65 157,65" fill="var(--accent)" opacity="0.6"/>

            <!-- Legs -->
            <g class="leg-group" data-leg="0">
              <line x1="195" y1="70" x2="250" y2="35" stroke="#6b7280" stroke-width="3"/>
              <circle class="leg-circle" cx="250" cy="35" r="18"/>
              <text class="leg-label" x="250" y="40">L0</text>
            </g>
            <g class="leg-group" data-leg="1">
              <line x1="200" y1="100" x2="270" y2="100" stroke="#6b7280" stroke-width="3"/>
              <circle class="leg-circle" cx="270" cy="100" r="18"/>
              <text class="leg-label" x="270" y="105">L1</text>
            </g>
            <g class="leg-group" data-leg="2">
              <line x1="195" y1="130" x2="250" y2="165" stroke="#6b7280" stroke-width="3"/>
              <circle class="leg-circle" cx="250" cy="165" r="18"/>
              <text class="leg-label" x="250" y="170">L2</text>
            </g>
            <g class="leg-group" data-leg="3">
              <line x1="105" y1="130" x2="50" y2="165" stroke="#6b7280" stroke-width="3"/>
              <circle class="leg-circle" cx="50" cy="165" r="18"/>
              <text class="leg-label" x="50" y="170">L3</text>
            </g>
            <g class="leg-group" data-leg="4">
              <line x1="100" y1="100" x2="30" y2="100" stroke="#6b7280" stroke-width="3"/>
              <circle class="leg-circle" cx="30" cy="100" r="18"/>
              <text class="leg-label" x="30" y="105">L4</text>
            </g>
            <g class="leg-group" data-leg="5">
              <line x1="105" y1="70" x2="50" y2="35" stroke="#6b7280" stroke-width="3"/>
              <circle class="leg-circle" cx="50" cy="35" r="18"/>
              <text class="leg-label" x="50" y="40">L5</text>
            </g>
          </svg>
        </div>

        <div class="panel-title" style="margin-top: 20px;">
          <span>Channel Map (0-17)</span>
        </div>
        <div class="channel-map" id="channelMap">
          <!-- Channels 0-17 will be rendered by JS -->
        </div>

        <div class="actions" style="margin-top: 20px;">
          <button class="action-btn warning" id="neutralAllBtn">All to 90°</button>
          <button class="action-btn secondary" id="reloadBtn">Reload</button>
          <button class="action-btn success" id="saveBtn">Save</button>
        </div>
      </div>

      <!-- Right Panel: Joint Controls -->
      <div class="panel">
        <div class="panel-title">
          <span id="selectedLegTitle">Select a leg to configure</span>
        </div>

        <div class="joint-controls" id="jointControls">
          <!-- Coxa -->
          <div class="joint-row" data-joint="0">
            <div class="joint-header">
              <span class="joint-name">Coxa (horizontal rotation)</span>
              <div class="joint-channel">
                <span style="color: var(--muted); font-size: 12px;">Channel:</span>
                <input type="number" class="channel-input" id="coxaChannel" min="0" max="17" placeholder="-">
                <button class="test-btn" data-joint="0">Test</button>
              </div>
            </div>
            <div class="angle-control">
              <span style="color: var(--muted); font-size: 11px;">0°</span>
              <input type="range" class="angle-slider" id="coxaAngle" min="0" max="180" value="90" disabled>
              <span style="color: var(--muted); font-size: 11px;">180°</span>
              <span class="angle-value" id="coxaAngleValue">90°</span>
            </div>
          </div>

          <!-- Femur -->
          <div class="joint-row" data-joint="1">
            <div class="joint-header">
              <span class="joint-name">Femur (upper leg)</span>
              <div class="joint-channel">
                <span style="color: var(--muted); font-size: 12px;">Channel:</span>
                <input type="number" class="channel-input" id="femurChannel" min="0" max="17" placeholder="-">
                <button class="test-btn" data-joint="1">Test</button>
              </div>
            </div>
            <div class="angle-control">
              <span style="color: var(--muted); font-size: 11px;">0°</span>
              <input type="range" class="angle-slider" id="femurAngle" min="0" max="180" value="90" disabled>
              <span style="color: var(--muted); font-size: 11px;">180°</span>
              <span class="angle-value" id="femurAngleValue">90°</span>
            </div>
          </div>

          <!-- Tibia -->
          <div class="joint-row" data-joint="2">
            <div class="joint-header">
              <span class="joint-name">Tibia (lower leg)</span>
              <div class="joint-channel">
                <span style="color: var(--muted); font-size: 12px;">Channel:</span>
                <input type="number" class="channel-input" id="tibiaChannel" min="0" max="17" placeholder="-">
                <button class="test-btn" data-joint="2">Test</button>
              </div>
            </div>
            <div class="angle-control">
              <span style="color: var(--muted); font-size: 11px;">0°</span>
              <input type="range" class="angle-slider" id="tibiaAngle" min="0" max="180" value="90" disabled>
              <span style="color: var(--muted); font-size: 11px;">180°</span>
              <span class="angle-value" id="tibiaAngleValue">90°</span>
            </div>
          </div>
        </div>

        <div class="panel-title" style="margin-top: 24px;">
          <span>Quick Test</span>
        </div>
        <div class="quick-test">
          <button class="quick-btn" data-angle="0">0°</button>
          <button class="quick-btn" data-angle="45">45°</button>
          <button class="quick-btn" data-angle="90">90°</button>
          <button class="quick-btn" data-angle="135">135°</button>
          <button class="quick-btn" data-angle="180">180°</button>
          <button class="quick-btn" data-action="sweep">Sweep</button>
          <button class="quick-btn" data-action="center-all">Center All</button>
          <button class="quick-btn" data-action="stop">Stop</button>
        </div>

        <div class="panel-title" style="margin-top: 24px;">
          <span>Log</span>
        </div>
        <div class="log-area" id="logArea"></div>
      </div>
    </div>

    <footer>
      <p>Hexapod Calibration Tool | <a href="http://localhost:8000" target="_blank">Back to Controller</a></p>
    </footer>
  </div>

  <script>
    // State
    let selectedLeg = null;
    let calibration = {};
    let ws = null;
    let isHardware = false;
    let sweepInterval = null;

    const jointNames = ['coxa', 'femur', 'tibia'];

    // DOM Elements
    const logArea = document.getElementById('logArea');
    const connectionDot = document.getElementById('connectionDot');
    const connectionText = document.getElementById('connectionText');
    const hardwareDot = document.getElementById('hardwareDot');
    const hardwareText = document.getElementById('hardwareText');
    const serverEndpoint = document.getElementById('serverEndpoint');
    const calibrationPath = document.getElementById('calibrationPath');
    const calibrationMeta = document.getElementById('calibrationMeta');
    const mappingSummary = document.getElementById('mappingSummary');
    const mappingMeta = document.getElementById('mappingMeta');
    const selectedLegTitle = document.getElementById('selectedLegTitle');

    // Logging
    function log(msg, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const time = new Date().toLocaleTimeString();
      entry.textContent = `[${time}] ${msg}`;
      logArea.appendChild(entry);
      logArea.scrollTop = logArea.scrollHeight;
    }

    function formatBytes(bytes) {
      if (!bytes) return '0 B';
      const units = ['B', 'KB', 'MB', 'GB'];
      const exponent = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), units.length - 1);
      const value = bytes / (1024 ** exponent);
      return `${value.toFixed(value >= 10 ? 0 : 1)} ${units[exponent]}`;
    }

    function updateMetadata(meta) {
      if (!meta) {
        calibrationPath.textContent = 'Unknown';
        calibrationMeta.textContent = 'Waiting for calibration metadata...';
        return;
      }

      calibrationPath.textContent = meta.path || 'Unknown path';
      if (meta.exists) {
        const modified = meta.last_modified ? new Date(meta.last_modified).toLocaleString() : 'Unknown time';
        calibrationMeta.textContent = `Saved ${modified} · ${formatBytes(meta.size)}`;
      } else {
        calibrationMeta.textContent = 'File will be created on first save';
      }
    }

    function updateMappingSummary() {
      const mapped = Object.keys(calibration).length;
      const totalJoints = 18; // 6 legs * 3 joints
      const legsCovered = new Set(Object.keys(calibration).map(key => key.split(',')[0])).size;

      mappingSummary.textContent = `${mapped} / ${totalJoints} joints mapped`;
      mappingMeta.textContent = `${legsCovered} of 6 legs configured`;
    }

    // WebSocket connection
    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}/ws`);

      ws.onopen = () => {
        connectionDot.classList.add('connected');
        connectionText.textContent = 'Connected';
        log('Connected to calibration server', 'info');
        ws.send(JSON.stringify({ type: 'get_status' }));
      };

      ws.onclose = () => {
        connectionDot.classList.remove('connected');
        connectionText.textContent = 'Disconnected';
        log('Disconnected from server', 'error');
        setTimeout(connect, 2000);
      };

      ws.onerror = (e) => {
        log('WebSocket error', 'error');
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleMessage(data);
      };
    }

    function handleMessage(data) {
      if (data.metadata) {
        updateMetadata(data.metadata);
      }

      if (data.hardware !== undefined) {
        isHardware = data.hardware;
        hardwareDot.classList.toggle('hardware', isHardware);
        hardwareText.textContent = `Hardware: ${isHardware ? 'PCA9685' : 'Mock'}`;
      }

      if (data.calibration) {
        calibration = data.calibration;
        updateChannelMap();
        updateLegDisplay();
      }

      if (data.success && data.key) {
        if (data.channel !== undefined) {
          calibration[data.key] = data.channel;
        } else {
          delete calibration[data.key];
        }
        updateChannelMap();
        updateLegDisplay();
      }

      if (data.success !== undefined) {
        if (data.success) {
          log(data.message || 'Operation successful', 'info');
        } else {
          log(data.error || 'Operation failed', 'error');
        }
      }

      if (data.results) {
        data.results.forEach(r => {
          log(`Channel ${r.channel}: ${r.success ? 'OK' : r.error}`, r.success ? 'info' : 'error');
        });
      }
    }

    // Send command via WebSocket
    function send(data) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(data));
      } else {
        log('Not connected', 'error');
      }
    }

    // Set servo angle
    function setServoAngle(channel, angle) {
      if (channel === null || channel === undefined || channel === '') return;
      send({ type: 'set_angle', channel: parseInt(channel), angle: parseFloat(angle) });
      log(`Set channel ${channel} to ${angle}°`);
    }

    // Update channel map display
    function updateChannelMap() {
      const map = document.getElementById('channelMap');
      map.innerHTML = '';

      for (let i = 0; i < 18; i++) {
        const slot = document.createElement('div');
        slot.className = 'channel-slot';
        slot.dataset.channel = i;

        // Check if this channel is used
        let usedBy = null;
        for (const [key, ch] of Object.entries(calibration)) {
          if (ch === i) {
            const [leg, joint] = key.split(',').map(Number);
            usedBy = `L${leg} ${jointNames[joint]}`;
            slot.classList.add('occupied');
            break;
          }
        }

        slot.innerHTML = `
          <span class="ch-num">${i}</span>
          <span class="ch-label">${usedBy || 'unused'}</span>
        `;

        slot.addEventListener('click', () => {
          // Quick channel assignment if leg is selected
          if (selectedLeg !== null) {
            // Cycle through joints
            const joints = document.querySelectorAll('.joint-row');
            let foundEmpty = false;
            for (const joint of joints) {
              const input = joint.querySelector('.channel-input');
              if (input.value === '' || input.value === '-') {
                input.value = i;
                input.dispatchEvent(new Event('change'));
                foundEmpty = true;
                break;
              }
            }
            if (!foundEmpty) {
              log(`All joints for Leg ${selectedLeg} already assigned`, 'warn');
            }
          }
        });

        map.appendChild(slot);
      }

      updateMappingSummary();
    }

    // Update leg visual display
    function updateLegDisplay() {
      document.querySelectorAll('.leg-group').forEach(g => {
        const leg = parseInt(g.dataset.leg);
        const hasConfig = Object.keys(calibration).some(k => k.startsWith(`${leg},`));
        g.classList.toggle('configured', hasConfig);
      });
    }

    // Load joint controls for selected leg
    function loadLegControls(leg) {
      selectedLegTitle.textContent = `Leg ${leg} Configuration`;

      jointNames.forEach((name, joint) => {
        const key = `${leg},${joint}`;
        const channel = calibration[key];

        const input = document.getElementById(`${name}Channel`);
        const slider = document.getElementById(`${name}Angle`);

        input.value = channel !== undefined ? channel : '';
        slider.disabled = channel === undefined;
        slider.value = 90;
        document.getElementById(`${name}AngleValue`).textContent = '90°';
      });
    }

    // Leg selection
    document.querySelectorAll('.leg-group').forEach(g => {
      g.addEventListener('click', () => {
        const leg = parseInt(g.dataset.leg);

        // Toggle selection
        document.querySelectorAll('.leg-group').forEach(lg => lg.classList.remove('selected'));
        g.classList.add('selected');
        selectedLeg = leg;

        loadLegControls(leg);
        log(`Selected Leg ${leg}`);
      });
    });

    // Channel input changes
    jointNames.forEach((name, joint) => {
      const input = document.getElementById(`${name}Channel`);
      const slider = document.getElementById(`${name}Angle`);
      const valueDisplay = document.getElementById(`${name}AngleValue`);

      input.addEventListener('change', () => {
        if (selectedLeg === null) return;

        const channel = input.value;
        if (channel !== '' && channel !== '-') {
          send({
            type: 'set_mapping',
            leg: selectedLeg,
            joint: joint,
            channel: parseInt(channel)
          });
          slider.disabled = false;
          log(`Mapped Leg ${selectedLeg} ${name} to channel ${channel}`);
        } else {
          slider.disabled = true;
        }
      });

      slider.addEventListener('input', () => {
        const angle = slider.value;
        valueDisplay.textContent = `${angle}°`;
        const channel = input.value;
        if (channel !== '' && channel !== '-') {
          setServoAngle(channel, angle);
        }
      });
    });

    // Test buttons
    document.querySelectorAll('.test-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const joint = parseInt(btn.dataset.joint);
        const name = jointNames[joint];
        const channel = document.getElementById(`${name}Channel`).value;

        if (channel === '' || channel === '-') {
          log(`No channel assigned for ${name}`, 'warn');
          return;
        }

        btn.classList.add('testing');
        log(`Testing ${name} (channel ${channel})...`);

        // Sweep test
        let angle = 45;
        let direction = 1;
        const testInterval = setInterval(() => {
          setServoAngle(channel, angle);
          document.getElementById(`${name}Angle`).value = angle;
          document.getElementById(`${name}AngleValue`).textContent = `${angle}°`;

          angle += direction * 5;
          if (angle >= 135) direction = -1;
          if (angle <= 45) {
            clearInterval(testInterval);
            setServoAngle(channel, 90);
            document.getElementById(`${name}Angle`).value = 90;
            document.getElementById(`${name}AngleValue`).textContent = '90°';
            btn.classList.remove('testing');
            log(`${name} test complete`);
          }
        }, 50);
      });
    });

    // Quick test buttons
    document.querySelectorAll('.quick-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const angle = btn.dataset.angle;
        const action = btn.dataset.action;

        if (angle) {
          // Set all enabled sliders to this angle
          jointNames.forEach(name => {
            const channel = document.getElementById(`${name}Channel`).value;
            if (channel !== '' && channel !== '-') {
              setServoAngle(channel, parseFloat(angle));
              document.getElementById(`${name}Angle`).value = angle;
              document.getElementById(`${name}AngleValue`).textContent = `${angle}°`;
            }
          });
        } else if (action === 'sweep') {
          // Sweep all joints
          if (sweepInterval) {
            clearInterval(sweepInterval);
            sweepInterval = null;
            log('Sweep stopped');
            return;
          }

          let angle = 45;
          let direction = 1;
          sweepInterval = setInterval(() => {
            jointNames.forEach(name => {
              const channel = document.getElementById(`${name}Channel`).value;
              if (channel !== '' && channel !== '-') {
                setServoAngle(channel, angle);
                document.getElementById(`${name}Angle`).value = angle;
                document.getElementById(`${name}AngleValue`).textContent = `${angle}°`;
              }
            });
            angle += direction * 2;
            if (angle >= 135) direction = -1;
            if (angle <= 45) direction = 1;
          }, 30);
          log('Sweeping...');

        } else if (action === 'center-all') {
          // Center all configured servos
          send({ type: 'neutral_all' });
          log('Centering all servos to 90°');

        } else if (action === 'stop') {
          if (sweepInterval) {
            clearInterval(sweepInterval);
            sweepInterval = null;
            log('Sweep stopped');
          }
        }
      });
    });

    // Global actions
    document.getElementById('neutralAllBtn').addEventListener('click', () => {
      send({ type: 'neutral_all' });
      // Update UI
      jointNames.forEach(name => {
        document.getElementById(`${name}Angle`).value = 90;
        document.getElementById(`${name}AngleValue`).textContent = '90°';
      });
    });

    document.getElementById('saveBtn').addEventListener('click', () => {
      send({ type: 'save' });
      log('Saving calibration...', 'info');
    });

    document.getElementById('reloadBtn').addEventListener('click', async () => {
      try {
        const resp = await fetch('/api/calibration/reload', { method: 'POST' });
        const data = await resp.json();
        if (data.success) {
          calibration = data.calibration;
          updateMetadata(data.metadata);
          updateChannelMap();
          updateLegDisplay();
          if (selectedLeg !== null) loadLegControls(selectedLeg);
          log('Calibration reloaded', 'info');
        } else {
          log(data.error, 'error');
        }
      } catch (e) {
        log('Reload failed: ' + e.message, 'error');
      }
    });

    // Initialize
    async function init() {
      log('Initializing calibration UI...');

      serverEndpoint.textContent = window.location.origin;

      // Load initial calibration
      try {
        const resp = await fetch('/api/calibration');
        const data = await resp.json();
        calibration = data.calibration || {};
        isHardware = data.hardware;
        updateMetadata(data.metadata);
        hardwareDot.classList.toggle('hardware', isHardware);
        hardwareText.textContent = `Hardware: ${isHardware ? 'PCA9685' : 'Mock'}`;
        updateChannelMap();
        updateLegDisplay();
      } catch (e) {
        log('Failed to load calibration: ' + e.message, 'error');
      }

      // Connect WebSocket
      connect();
    }

    init();
  </script>
</body>
</html>
